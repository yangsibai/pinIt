// Generated by CoffeeScript 1.7.1
(function() {
  var ajax, getLocalPin, getRemotePin, newPin, saveLocal, serverAddress;

  serverAddress = "http://api.heshui.la";

  chrome.browserAction.onClicked.addListener(function(tab) {
    if (tab) {
      chrome.tabs.sendMessage(tab.id, {
        cmd: "new",
        pins: getLocalPin(tab.url)
      }, function(data) {
        return console.dir(data);
      });
      return getRemotePin(tab.url, function(err, pins) {
        if (err) {
          return alert(err.message);
        } else if (pins && pins.length > 0) {
          return chrome.tabs.sendMessage(tab.id, {
            cmd: "data",
            pins: pins
          }, function(data) {
            return console.dir(data);
          });
        }
      });
    }
  });

  chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
    request.data.url = sender.url;
    request.data.title = sender.tab.title;
    return newPin(request.data);
  });


  /*
      set browser action badge and title
   */

  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
    return ajax.get("" + serverAddress + "/pin/countOnPage", {
      url: tab.url
    }, function(res) {
      if (res.code === 0) {
        chrome.browserAction.setBadgeText({
          text: res.count + "",
          tabId: tabId
        });
        chrome.browserAction.setBadgeBackgroundColor({
          color: "#F00",
          tabId: tabId
        });
        return chrome.browserAction.setTitle({
          title: "" + res.count + " pin",
          tabId: tabId
        });
      }
    });
  });


  /*
      create new pin
   */

  newPin = function(data) {
    ajax.post("" + serverAddress + "/pin/new", data, function(res) {
      if (res.code !== 0) {
        return alert(res.message);
      }
    });
    return saveLocal(data);
  };


  /*
      save in local storage
   */

  saveLocal = function(data) {
    var foundPIN, foundURL, item, pin, storage, _i, _j, _len, _len1, _ref;
    if (localStorage && localStorage.data) {
      storage = JSON.parse(localStorage.data);
    } else {
      storage = [];
    }
    for (_i = 0, _len = storage.length; _i < _len; _i++) {
      item = storage[_i];
      if (item.url === data.url) {
        foundURL = true;
        _ref = item.pins;
        for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
          pin = _ref[_j];
          if (pin.x === data.x && pin.y === data.y) {
            foundPIN = true;
            pin.text = data.text;
            break;
          }
        }
        if (!foundPIN) {
          item.pins.push({
            x: data.x,
            y: data.y,
            text: data.text
          });
        }
        break;
      }
    }
    if (!foundURL) {
      storage.push({
        url: data.url,
        title: data.title,
        pins: [
          {
            x: data.x,
            y: data.y,
            text: data.text
          }
        ]
      });
    }
    return localStorage.data = JSON.stringify(storage);
  };


  /*
      get local pins
   */

  getLocalPin = function(url) {
    var item, storage, _i, _len;
    if (localStorage && localStorage.data) {
      storage = JSON.parse(localStorage.data);
      for (_i = 0, _len = storage.length; _i < _len; _i++) {
        item = storage[_i];
        if (item.url === url) {
          return item.pins;
        }
      }
    }
    return [];
  };


  /*
      get pin from remote server
   */

  getRemotePin = function(url, cb) {
    return ajax.get("" + serverAddress + "/pin/pinOnPage", {
      url: url
    }, function(res) {
      var pin, _i, _len, _ref, _results;
      if (res.code === 0) {
        cb(null, res.pins);
        _ref = res.pins;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          pin = _ref[_i];
          _results.push(saveLocal(pin));
        }
        return _results;
      } else {
        return cb(new Error(res.message));
      }
    });
  };

  ajax = {
    x: function() {
      var e, version, versions, xhr, _i, _len;
      if (typeof XMLHttpRequest !== "undefined") {
        return new XMLHttpRequest();
      }
      versions = ["MSXML2.XmlHttp.5.0", "MSXML2.XmlHttp.4.0", "MSXML2.XmlHttp.3.0", "MSXML2.XmlHttp.2.0", "Microsoft.XmlHttp"];
      for (_i = 0, _len = versions.length; _i < _len; _i++) {
        version = versions[_i];
        try {
          xhr = new ActiveXObject(version);
          break;
        } catch (_error) {
          e = _error;
        }
      }
      return xhr;
    },
    send: function(url, cb, method, data, sync) {
      var x;
      x = ajax.x();
      x.open(method, url, sync);
      x.onreadystatechange = function() {
        var e;
        if (x.readyState === 4) {
          try {
            cb(JSON.parse(x.responseText));
            return;
          } catch (_error) {
            e = _error;
          }
          return cb(x.responseText);
        }
      };
      if (method === "POST") {
        x.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      }
      return x.send(data);
    },
    get: function(url, data, cb, sync) {
      var key, query, value;
      query = [];
      for (key in data) {
        value = data[key];
        query.push("" + (encodeURIComponent(key)) + "=" + (encodeURIComponent(value)));
      }
      return ajax.send(url + "?" + query.join('&'), cb, 'GET', null, sync);
    },
    post: function(url, data, cb, sync) {
      var key, query, value;
      query = [];
      for (key in data) {
        value = data[key];
        query.push("" + (encodeURIComponent(key)) + "=" + (encodeURIComponent(value)));
      }
      return ajax.send(url, cb, 'POST', query.join('&'), sync);
    }
  };

}).call(this);

//# sourceMappingURL=background.map
